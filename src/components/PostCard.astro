---
import type { CollectionEntry } from "astro:content";
import path from "node:path";
import { Icon } from "astro-icon/components";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import { getDir } from "../utils/url-utils";
import ImageWrapper from "./misc/ImageWrapper.astro";
import PostMetadata from "./PostMeta.astro";

interface Props {
	class?: string;
	entry: CollectionEntry<"posts">;
	title: string;
	url: string;
	published: Date;
	updated?: Date;
	tags: string[];
	category: string | null;
	image: string;
	description: string;
	draft: boolean;
	// ğŸš€ æ¥æ”¶ä» PostPage ä¼ æ¥çš„ç´¢å¼•
    staggerIndex: number;
	// âš ï¸ ç§»é™¤ style å±æ€§ï¼Œé¿å…ä¸æ–°çš„ style å†²çª
	// style: string;
}
const {
	entry,
	title,
	url,
	published,
	updated,
	tags,
	category,
	image,
	description,
    staggerIndex,
	// style,
} = Astro.props;
const className = Astro.props.class;

const hasCover = image !== undefined && image !== null && image !== "";

const coverWidth = "28%";

const { remarkPluginFrontmatter } = await entry.render();
---
<!-- 1. åº”ç”¨ card-base (ç¾åŒ–) å’Œ post-card-item (åŠ¨ç”») ç±» -->
<!-- 2. è®¾ç½® CSS å˜é‡ --post-indexï¼Œä¾› [...page].astro ä¸­çš„ CSS è®¡ç®—åŠ¨ç”»å»¶è¿Ÿ -->
<div 
    class:list={[
        "card-base post-card-item flex flex-col-reverse md:flex-col w-full rounded-[var(--radius-large)] overflow-hidden relative", 
        className
    ]} 
    style={`--post-index: ${staggerIndex};`}
>
    <div class:list={["pl-6 md:pl-9 pr-6 md:pr-2 pt-6 md:pt-7 pb-6 relative", {"w-full": !hasCover, "md:w-[calc(100%-var(--coverWidth))]": hasCover}]}>
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <h2 class="relative flex flex-col mb-4 md:mb-5 z-20">
            <a href={url} aria-label={title}
               class="transition text-xl md:text-2xl font-bold\
                      hover:text-[var(--theme-primary)] dark:hover:text-[var(--theme-primary)]\
                      text-ellipsis line-clamp-2 md:line-clamp-3 post-card-title"
            >
                {title}
            </a>
            {remarkPluginFrontmatter && remarkPluginFrontmatter.toc.length > 0 && 
                <div class="transition text-[var(--primary)] text-50 text-sm mt-1">\
                    <Icon name="material-symbols:toc-rounded" class="text-lg mr-1 translate-y-[-0.075rem] inline-block"></Icon>\
                    {i18n(I18nKey.hasToc)}\
                </div>
            }
        </h2>
        
        <!-- æ‘˜è¦/æè¿° -->
        <div class="transition text-75 text-sm md:text-base line-clamp-3 mb-6 md:mb-8">
            {description}
        </div>
        
        <!-- å…ƒæ•°æ® -->
        <PostMetadata
            published={published}
            updated={updated}
            tags={tags}
            category={category}
            class="text-40"
            hideTagsForMobile
            hideUpdateDate
        />

        <!-- ç§»åŠ¨ç«¯å°é¢å›¾ç‰‡ï¼Œå¦‚æœå­˜åœ¨ -->
        {hasCover && 
            <a href={url} aria-label={title} class:list={[\
                        "md:hidden my-4",\
                        "md:w-[var(--coverWidth)] relative md:absolute md:top-3 md:bottom-3 md:right-3 rounded-xl overflow-hidden active:scale-95"\
                    ]} >
                <div class="absolute pointer-events-none z-10 w-full h-full group-hover:bg-black/30 group-active:bg-black/50 transition"></div>
                <div class="absolute pointer-events-none z-20 w-full h-full flex items-center justify-center ">
                    <Icon name="material-symbols:chevron-right-rounded"
                          class="transition opacity-0 group-hover:opacity-100 scale-50 group-hover:scale-100 text-white text-5xl">
                    </Icon>
                </div>
                <ImageWrapper src={image} basePath={path.join("content/posts/", getDir(entry.id))} alt="Cover Image of the Post"
                              class="w-full h-full">
                </ImageWrapper>
            </a>}
    </div>

    <!-- æ¡Œé¢ç«¯å°é¢å›¾ç‰‡æˆ–è¿›å…¥æŒ‰é’® -->
    {hasCover &&
        <a href={url} aria-label={title} class:list={[\
                        "hidden md:flex my-4 md:my-0",\
                        "md:w-[var(--coverWidth)] relative md:absolute md:top-3 md:bottom-3 md:right-3 rounded-xl overflow-hidden active:scale-95"\
                    ]} >
        <div class="absolute pointer-events-none z-10 w-full h-full group-hover:bg-black/30 group-active:bg-black/50 transition"></div>
        <div class="absolute pointer-events-none z-20 w-full h-full flex items-center justify-center ">
            <Icon name="material-symbols:chevron-right-rounded"
                  class="transition opacity-0 group-hover:opacity-100 scale-50 group-hover:scale-100 text-white text-5xl">
            </Icon>
        </div>
        <ImageWrapper src={image} basePath={path.join("content/posts/", getDir(entry.id))} alt="Cover Image of the Post"
                  class="w-full h-full">
        </ImageWrapper>
    </a>}

    {!hasCover &&
        <a href={url} aria-label={title} class="!hidden md:!flex btn-regular w-[3.25rem]\
         absolute right-3 top-3 bottom-3 rounded-xl bg-[var(--enter-btn-bg)]\
         hover:bg-[var(--enter-btn-bg-hover)] active:bg-[var(--enter-btn-bg-active)] active:scale-95\
        ">
            <Icon name="material-symbols:chevron-right-rounded"
                  class="transition text-[var(--primary)] text-4xl mx-auto my-auto">\
            </Icon>
        </a>
    }
</div>